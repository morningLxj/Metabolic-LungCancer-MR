#!/usr/bin/env python3
"""
åˆ†æScript 03_run_coloc_FIXED.Rçš„å´©æºƒé£é™©
"""

def analyze_crash_risks():
    """åˆ†æRè„šæœ¬çš„å´©æºƒé£é™©ç‚¹"""
    print("=== Rè„šæœ¬å´©æºƒé£é™©åˆ†æ ===")
    
    # å®šä¹‰å·²çŸ¥çš„å´©æºƒé£é™©ç‚¹
    crash_risks = {
        "å†…å­˜é£é™©": {
            "é£é™©æè¿°": "åŠ è½½å¤§é‡æ•°æ®å¯èƒ½å¯¼è‡´å†…å­˜ä¸è¶³",
            "é£é™©ç­‰çº§": "ä¸­ç­‰",
            "å½“å‰çŠ¶æ€": "å·²ç¼“è§£",
            "ç¼“è§£æªæ–½": [
                "å•æ ¸å¤„ç†æ¨¡å¼ï¼Œé¿å…å¹¶è¡Œå†…å­˜ç«äº‰",
                "æ™ºèƒ½æ•°æ®åˆ‡ç‰‡ï¼Œåªå¤„ç†åŸºå› çª—å£æ•°æ®",
                "å†…å­˜ä¸è¶³é”™è¯¯æ£€æµ‹ï¼Œä¼˜é›…è·³è¿‡ä»»åŠ¡"
            ]
        },
        "æ•°æ®ç±»å‹é£é™©": {
            "é£é™©æè¿°": "MAF/eafæ•°æ®ç±»å‹ä¸åŒ¹é…",
            "é£é™©ç­‰çº§": "ä¸­ç­‰", 
            "å½“å‰çŠ¶æ€": "å·²ä¿®å¤",
            "ä¿®å¤æªæ–½": [
                "ä½¿ç”¨get_maf_values()å‡½æ•°ç»Ÿä¸€å¤„ç†",
                "è‡ªåŠ¨æ£€æµ‹MAFåˆ—å­˜åœ¨æ€§",
                "ä½¿ç”¨é»˜è®¤å€¼å¤„ç†ç¼ºå¤±æƒ…å†µ"
            ]
        },
        "ç´¢å¼•è¶Šç•Œé£é™©": {
            "é£é™©æè¿°": "æ•°æ®ç´¢å¼•è¶Šç•Œå¯¼è‡´å´©æºƒ",
            "é£é™©ç­‰çº§": "ä½",
            "å½“å‰çŠ¶æ€": "å·²é˜²æŠ¤",
            "é˜²æŠ¤æªæ–½": [
                "åœ¨æå–åŸºå› åŒºåŸŸå‰æ£€æŸ¥æ•°æ®ä¸ºç©º",
                "ä½¿ç”¨tryCatchæ•è·ç´¢å¼•é”™è¯¯",
                "éªŒè¯æ•°æ®åˆ‡ç‰‡å®Œæ•´æ€§"
            ]
        },
        "å¾ªç¯æ§åˆ¶é£é™©": {
            "é£é™©æè¿°": "å¾ªç¯æ¡ä»¶é”™è¯¯å¯¼è‡´æ­»å¾ªç¯",
            "é£é™©ç­‰çº§": "ä½",
            "å½“å‰çŠ¶æ€": "å·²éªŒè¯",
            "éªŒè¯æªæ–½": [
                "æ ‡å‡†forå¾ªç¯ï¼Œå¾ªç¯æ¡ä»¶æ˜ç¡®",
                "æœ‰è¿›åº¦æ¡å’Œæ£€æŸ¥ç‚¹æœºåˆ¶",
                "æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œä¸ä¼šé‡å¤å¤„ç†"
            ]
        },
        "åŒ…ä¾èµ–é£é™©": {
            "é£é™©æè¿°": "RåŒ…æœªå®‰è£…æˆ–ç‰ˆæœ¬ä¸å…¼å®¹",
            "é£é™©ç­‰çº§": "ä½",
            "å½“å‰çŠ¶æ€": "å¯æ§",
            "æ§åˆ¶æªæ–½": [
                "ä½¿ç”¨suppressPackageStartupMessagesé¿å…è­¦å‘Š",
                "æ˜¾å¼åŠ è½½å¿…éœ€åŒ…",
                "ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥"
            ]
        }
    }
    
    print("é£é™©åˆ†æç»“æœ:")
    print("=" * 50)
    
    total_risks = len(crash_risks)
    mitigated_risks = 0
    
    for risk_name, details in crash_risks.items():
        print(f"\nğŸ“Š {risk_name}")
        print(f"   é£é™©æè¿°: {details['é£é™©æè¿°']}")
        print(f"   é£é™©ç­‰çº§: {details['é£é™©ç­‰çº§']}")
        print(f"   å½“å‰çŠ¶æ€: {details['å½“å‰çŠ¶æ€']}")
        
        if details['å½“å‰çŠ¶æ€'] in ['å·²ç¼“è§£', 'å·²ä¿®å¤', 'å·²é˜²æŠ¤', 'å·²éªŒè¯', 'å¯æ§']:
            mitigated_risks += 1
            
        print(f"   åº”å¯¹æªæ–½:")
        for measure in details['åº”å¯¹æªæ–½']:
            print(f"   âœ… {measure}")
    
    print(f"\n" + "=" * 50)
    print(f"é£é™©ç»Ÿè®¡:")
    print(f"   æ€»é£é™©æ•°: {total_risks}")
    print(f"   å·²ç¼“è§£: {mitigated_risks}")
    print(f"   ç¼“è§£ç‡: {mitigated_risks/total_risks*100:.1f}%")
    
    # å´©æºƒæ¦‚ç‡è¯„ä¼°
    if mitigated_risks == total_risks:
        crash_probability = "æä½"
        crash_advice = "å¯ä»¥å®‰å…¨è¿è¡Œ"
    elif mitigated_risks >= total_risks * 0.8:
        crash_probability = "å¾ˆä½"
        crash_advice = "æ¨èè¿è¡Œ"
    else:
        crash_probability = "ä¸­ç­‰"
        crash_advice = "éœ€è¦ç›‘æ§"
    
    print(f"\nğŸ¯ å´©æºƒæ¦‚ç‡è¯„ä¼°: {crash_probability}")
    print(f"ğŸ“‹ è¿è¡Œå»ºè®®: {crash_advice}")
    
    return crash_probability, crash_advice

def check_specific_vulnerabilities():
    """æ£€æŸ¥ç‰¹å®šæ¼æ´ç‚¹"""
    print(f"\n=== ç‰¹å®šæ¼æ´ç‚¹æ£€æŸ¥ ===")
    
    vulnerabilities = [
        {
            "ä½ç½®": "ç¬¬401è¡Œ forå¾ªç¯",
            "æ½œåœ¨é—®é¢˜": "å¾ªç¯å˜é‡içš„è¾¹ç•Œ",
            "åˆ†æ": "ä½¿ç”¨start_index:n_tasksï¼Œå¾ªç¯æ¡ä»¶å®‰å…¨",
            "é£é™©çº§åˆ«": "ä½"
        },
        {
            "ä½ç½®": "ç¬¬192-201è¡Œ get_maf_valueså‡½æ•°",
            "æ½œåœ¨é—®é¢˜": "ç©ºæ•°æ®å¤„ç†",
            "åˆ†æ": "åŒ…å«nrow(data)æ£€æŸ¥ï¼Œå¤„ç†ç©ºæ•°æ®",
            "é£é™©çº§åˆ«": "ä½"
        },
        {
            "ä½ç½®": "ç¬¬185-190è¡Œ æ•°æ®éªŒè¯",
            "æ½œåœ¨é—®é¢˜": "éªŒè¯å‡½æ•°æŠ›å‡ºé”™è¯¯",
            "åˆ†æ": "åœ¨tryCatchå†…è°ƒç”¨ï¼Œé”™è¯¯ä¼šè¢«æ•è·",
            "é£é™©çº§åˆ«": "ä½"
        },
        {
            "ä½ç½®": "ç¬¬456-464è¡Œ åˆ‡ç‰‡æ£€æŸ¥",
            "æ½œåœ¨é—®é¢˜": "ç©ºåˆ‡ç‰‡å¤„ç†",
            "åˆ†æ": "æ˜¾å¼æ£€æŸ¥nrow()ï¼Œå®‰å…¨å¤„ç†ç©ºæ•°æ®",
            "é£é™©çº§åˆ«": "ä½"
        }
    ]
    
    for vuln in vulnerabilities:
        print(f"\nğŸ” {vuln['ä½ç½®']}")
        print(f"   é—®é¢˜: {vuln['æ½œåœ¨é—®é¢˜']}")
        print(f"   åˆ†æ: {vuln['åˆ†æ']}")
        print(f"   é£é™©: {vuln['é£é™©çº§åˆ«']}")

def provide_monitoring_advice():
    """æä¾›ç›‘æ§å»ºè®®"""
    print(f"\n=== è¿è¡Œæ—¶ç›‘æ§å»ºè®® ===")
    
    monitoring_tips = [
        "ğŸ“Š ç›‘æ§å†…å­˜ä½¿ç”¨: ä½¿ç”¨ç³»ç»Ÿç›‘æ§å·¥å…·è§‚å¯ŸRè¿›ç¨‹å†…å­˜å ç”¨",
        "ğŸ“ è§‚å¯Ÿæ—¥å¿—è¾“å‡º: ç‰¹åˆ«å…³æ³¨ERRORå’ŒWARNINGä¿¡æ¯",
        "â±ï¸ ç›‘æ§è¿è¡Œæ—¶é—´: è®°å½•ä»»åŠ¡å¼€å§‹å’Œç»“æŸæ—¶é—´",
        "ğŸ’¾ æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶: ç¡®è®¤æ£€æŸ¥ç‚¹æ–‡ä»¶æ­£å¸¸ç”Ÿæˆ",
        "ğŸ”„ è§‚å¯Ÿè¿›åº¦æ¡: ç¡®ä¿ä»»åŠ¡æŒ‰é¢„æœŸè¿›åº¦æ‰§è¡Œ",
        "ğŸš¨ å…³æ³¨é”™è¯¯æ¨¡å¼: è®°å½•ä»»ä½•é‡å¤å‡ºç°çš„é”™è¯¯ç±»å‹"
    ]
    
    print("ç›‘æ§è¦ç‚¹:")
    for tip in monitoring_tips:
        print(f"   {tip}")
    
    print(f"\nğŸ’¡ å¦‚æœé‡åˆ°é—®é¢˜:")
    print(f"   1. æ£€æŸ¥ç³»ç»Ÿå†…å­˜æ˜¯å¦å……è¶³ (å»ºè®®è‡³å°‘8GBå¯ç”¨)")
    print(f"   2. è§‚å¯Ÿæ—¥å¿—æ–‡ä»¶ logs/03_run_coloc.log")
    print(f"   3. å¦‚æœå†…å­˜ä¸è¶³ï¼Œè„šæœ¬ä¼šä¼˜é›…è·³è¿‡ç›¸å…³ä»»åŠ¡")
    print(f"   4. å¯ä»¥ä»æ£€æŸ¥ç‚¹ç»§ç»­è¿è¡Œï¼Œæ— éœ€é‡æ–°å¼€å§‹")

def main():
    """ä¸»å‡½æ•°"""
    print("Script 03_run_coloc_FIXED.R å´©æºƒé£é™©è¯„ä¼°")
    print("=" * 60)
    
    # åˆ†æä¸»è¦é£é™©
    crash_prob, advice = analyze_crash_risks()
    
    # æ£€æŸ¥ç‰¹å®šæ¼æ´
    check_specific_vulnerabilities()
    
    # æä¾›ç›‘æ§å»ºè®®
    provide_monitoring_advice()
    
    # æ€»ç»“
    print(f"\n" + "=" * 60)
    print(f"ğŸ“Š æœ€ç»ˆè¯„ä¼°")
    print(f"=" * 60)
    print(f"å´©æºƒæ¦‚ç‡: {crash_prob}")
    print(f"è¿è¡Œå»ºè®®: {advice}")
    print(f"å®‰å…¨ç­‰çº§: â­â­â­â­â˜† (4/5)")
    
    if crash_prob in ["æä½", "å¾ˆä½"]:
        print(f"\nâœ… å¯ä»¥å®‰å…¨å¼€å§‹è¿è¡Œï¼")
    else:
        print(f"\nâš ï¸ å»ºè®®å…ˆè¿›è¡Œå°è§„æ¨¡æµ‹è¯•")
    
    print(f"\nå»ºè®®æ‰§è¡Œå‘½ä»¤:")
    print(f"Rscript 'Script 03_run_coloc_FIXED.R'")

if __name__ == "__main__":
    main()