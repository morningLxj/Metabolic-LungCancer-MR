suppressMessages(library(data.table))
compute_probe_stats <- function(m_all, syn) { m_all[Gene %chin% syn & !is.na(Group), { bt <- Beta[Group=="Tumor"]; bn <- Beta[Group=="Normal"]; db <- mean(bt, na.rm = TRUE) - mean(bn, na.rm = TRUE); p <- tryCatch(wilcox.test(bt,bn)$p.value, error = function(e) NA_real_); .(Delta_Beta=db, P_value=p, N_Tumor=sum(!is.na(bt)), N_Normal=sum(!is.na(bn))) }, by=.(Gene,Probe,Region)][, Direction := ifelse(Delta_Beta>0,"Tumor>Normal","Tumor<Normal")][, FDR := p.adjust(P_value, method = "BH")] }
compute_probe_stats_cohort <- function(m_all, syn) { m_all[Gene %chin% syn & !is.na(Group), { bt <- Beta[Group=="Tumor"]; bn <- Beta[Group=="Normal"]; db <- mean(bt, na.rm = TRUE) - mean(bn, na.rm = TRUE); p <- tryCatch(wilcox.test(bt,bn)$p.value, error = function(e) NA_real_); .(Delta_Beta=db, P_value=p, N_Tumor=sum(!is.na(bt)), N_Normal=sum(!is.na(bn))) }, by=.(Cohort,Gene,Probe,Region)][, Direction := ifelse(Delta_Beta>0,"Tumor>Normal","Tumor<Normal")][, FDR := p.adjust(P_value, method = "BH"), by = Cohort] }
select_best <- function(ps) { s <- copy(ps); s[, absDelta := abs(Delta_Beta)]; setorder(s, Gene, FDR, -absDelta); s[, .SD[1], by = Gene] }
select_best_cohort <- function(psc) { s <- copy(psc); s[, absDelta := abs(Delta_Beta)]; setorder(s, Cohort, Gene, FDR, -absDelta); s[, .SD[1], by = .(Cohort,Gene)] }
